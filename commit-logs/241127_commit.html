<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/2c8bd78face34764.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-3c60486726093425.js"/><script src="/_next/static/chunks/fd9d1056-42bca7a501e26700.js" async=""></script><script src="/_next/static/chunks/23-0400f1ada3445968.js" async=""></script><script src="/_next/static/chunks/main-app-e0d78c455d046f20.js" async=""></script><script src="/_next/static/chunks/231-6a7b6dfd7bcbf59a.js" async=""></script><script src="/_next/static/chunks/app/layout-9e882b25b1c0b5ce.js" async=""></script><title>Create Next App</title><meta name="description" content="Generated by create next app"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__variable_1e4310 __variable_c3aa02 antialiased"><nav class="font-mono mx-16"><ul class="relative min-h-32 m-14 mb-10 flex flex-col md:flex-row md:space-x-12 space-y-1 justify-center md:justify-start items-center text-2xl md:text-3xl z-0 tracking-tight text-zinc-900"><li><a href="/">Home</a></li><li><a href="/learning-logs">Learning Logs</a></li><li><a href="/commit-logs">Commit logs</a></li></ul></nav><div class="flex justify-center py-10"><div class="page-background"><div class="flex flex-col prose dark:prose-invert w-full h-full max-h-none overflow-visible px-4"><h1 class="my-20 text-4xl">블로그 포스트 내 이미지 변환 로직 변경하기(with supabase)</h1>
<h2 class="mt-20 text-3xl text-blue-900">Trouble</h2>
<p>기존의 이미지 텍스트를 image url로 변환하는 로직은 단순히 index 의 숫자를 하나씩 증가 시켜 가면서 매칭시켰기 때문에 반드시 포스트 내 이미지의 순서와 supabase storage로부터 가져온 이미지 파일의 순서가 일치해야만 정상적으로 작동하는 로직이었습니다.</p>
<p>게다가 supabase의 storage로부터 파일명 리스트를 가져오는 <code>.list</code> 함수의 <code>sortBy</code> 옵션은 기본값을 제공하고 있지 않은데 기존의 코드는 <code>sortBy</code> 옵션을 지정해 두지도 않은 상태였습니다. 그럼에도 기본적으로 supabase storage 내에서의 파일 정렬이 파일의 <code>Name</code> 기준 오름차순으로 되어 있어 우연히 문제가 발생하지 않았던 것으로 보입니다.</p>
<p>이미지 url 변환을 단순 index에 의존하지 않고 이미지 파일명과 분명하게 매칭되는 경우에만 해당 파일명을 이미지 url로 변환하도록 합니다.</p>
<p>또한, 블로그 포스트에 쓰이는 이미지의 양이 방대하지 않은데 각각의 폴더로 별도로 저장하는 로직이 불필요하다는 생각이 들어 기존의 post title에 따라 각각 별도의 폴더에 이미지를 저장하던 방식에서 하나의 images 폴더에 해당 페이지의 전체 포스트 이미지들을 저장하는 방식으로 수정하기로 하였습니다.</p>
<h2 class="mt-20 text-3xl text-blue-900">Trouble 해결</h2>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">수정 전 코드</h3>
<pre><code>const { data: imageFileList, error } = await supabase.storage
    .from(&quot;posts&quot;)
    .list(`${page}/images/${postTitle}`);

const imageFileUrls = [];

for (const imageFile of imageFileList) {
    const { data } = supabase.storage
      .from(&quot;posts&quot;)
      .getPublicUrl(`${page}/images/${postTitle}/${imageFile.name}`);
	...
	imageFileUrls.push(data.publicUrl);
}
</code></pre>
<p><code>images</code> 폴더 내에 다시 각 포스트의 제목을 이름으로 하는 폴더가 존재하고 그 하위에 해당 포스트에만 쓰이는 이미지가 저장되어 있는 구조입니다.
이미지 url을 순차적으로 가져와 <code>imageFileUrls</code>에 저장하였습니다.</p>
<pre><code>text.replace(/!\[\[.*?\]\]/g, () =&gt; {
    const replacement = imageUrls[imageIndex] ? `![](${imageUrls[imageIndex]})` : &quot;[not found image]&quot;;
    imageIndex += 1;
    ...
};
</code></pre>
<p>블로그 텍스트에 이미지 텍스트가 존재하는 곳을 index 0 부터 순차적으로 저장해둔 image url로 변환하는 코드입니다.</p>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">수정 후 코드</h3>
<pre><code>const { data: imageFileList, error } = await supabase.storage
	.from(&quot;posts&quot;)
    .list(`${page}/images`);

const imageFileUrls: { [key: string]: string } = {};

for (const imageFile of imageFileList) {
    const { data } = supabase.storage
      .from(&quot;posts&quot;)
      .getPublicUrl(`${page}/images/${imageFile.name}`);
	...
	imageFileUrls[imageFile.name] = data.publicUrl;
}
</code></pre>
<p>images 폴더 하위에 블로그 내의 모든 이미지 파일이 존재합니다.
각 이미지의 url을 <code>imageFileUrls</code>  객체에 key와 value 값으로 저장합니다.</p>
<pre><code>text.replace(/!\[\[(.*?\.png)(\|\d+)?\]\]/g, (match, p1) =&gt; {
	const replacement = imageUrlsObj[p1] ? `![](${imageUrlsObj[p1]})` : &quot;[not found image]&quot;;
	...
}
</code></pre>
<p>블로그 텍스트에 이미지 텍스트가 존재하는 곳에 이미지 파일명이 <code>imageUrlsObj</code> 객체에 키로 존재하는 경우 해당하는 image url로 변환합니다.
만약 image url이 존재 하지 않는 경우 해당 이미지 텍스트를 <code>[not found image]</code>로 대체합니다.</p>
<h2 class="mt-20 text-3xl text-blue-900">reference</h2>
<pre><code>https://supabase.com/docs/reference/javascript/storage-from-list
</code></pre></div></div></div><script src="/_next/static/chunks/webpack-3c60486726093425.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/2c8bd78face34764.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[5751,[],\"\"]\n5:I[9275,[],\"\"]\n7:I[1343,[],\"\"]\n8:I[5767,[\"231\",\"static/chunks/231-6a7b6dfd7bcbf59a.js\",\"185\",\"static/chunks/app/layout-9e882b25b1c0b5ce.js\"],\"PostProvider\",1]\n9:I[231,[\"231\",\"static/chunks/231-6a7b6dfd7bcbf59a.js\",\"185\",\"static/chunks/app/layout-9e882b25b1c0b5ce.js\"],\"\"]\nb:I[6130,[],\"\"]\n6:[\"slug\",\"241127_commit\",\"d\"]\nc:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L2\",null,{\"buildId\":\"m_q4X4krJg2lMvwBwtsAs\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"commit-logs\",\"241127_commit\"],\"initialTree\":[\"\",{\"children\":[\"commit-logs\",{\"children\":[[\"slug\",\"241127_commit\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"241127_commit\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"commit-logs\",{\"children\":[[\"slug\",\"241127_commit\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\",null],null],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"commit-logs\",\"children\",\"$6\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"commit-logs\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2c8bd78face34764.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"$L8\",null,{\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_1e4310 __variable_c3aa02 antialiased\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"font-mono mx-16\",\"children\":[\"$\",\"ul\",null,{\"className\":\"relative min-h-32 m-14 mb-10 flex flex-col md:flex-row md:space-x-12 space-y-1 justify-center md:justify-start items-center text-2xl md:text-3xl z-0 tracking-tight text-zinc-900\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/\",\"children\":\"Home\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/learning-logs\",\"children\":\"Learning Logs\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/commit-logs\",\"children\":\"Commit logs\"}]}]]}]}],[\"$\",\"div\",null,{\"className\":\"flex justify-center py-10\",\"children\":[\"$\",\"div\",null,{\"className\":\"page-background\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]}]]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Create Next App\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Generated by create next app\"}]]\n3:null\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"className\":\"flex flex-col prose dark:prose-invert w-full h-full max-h-none overflow-visible px-4\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"my-20 text-4xl\",\"children\":\"블로그 포스트 내 이미지 변환 로직 변경하기(with supabase)\"}],\"\\n\",[\"$\",\"h2\",null,{\"className\":\"mt-20 text-3xl text-blue-900\",\"children\":\"Trouble\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"기존의 이미지 텍스트를 image url로 변환하는 로직은 단순히 index 의 숫자를 하나씩 증가 시켜 가면서 매칭시켰기 때문에 반드시 포스트 내 이미지의 순서와 supabase storage로부터 가져온 이미지 파일의 순서가 일치해야만 정상적으로 작동하는 로직이었습니다.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"게다가 supabase의 storage로부터 파일명 리스트를 가져오는 \",[\"$\",\"code\",null,{\"children\":\".list\"}],\" 함수의 \",[\"$\",\"code\",null,{\"children\":\"sortBy\"}],\" 옵션은 기본값을 제공하고 있지 않은데 기존의 코드는 \",[\"$\",\"code\",null,{\"children\":\"sortBy\"}],\" 옵션을 지정해 두지도 않은 상태였습니다. 그럼에도 기본적으로 supabase storage 내에서의 파일 정렬이 파일의 \",[\"$\",\"code\",null,{\"children\":\"Name\"}],\" 기준 오름차순으로 되어 있어 우연히 문제가 발생하지 않았던 것으로 보입니다.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"이미지 url 변환을 단순 index에 의존하지 않고 이미지 파일명과 분명하게 매칭되는 경우에만 해당 파일명을 이미지 url로 변환하도록 합니다.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"또한, 블로그 포스트에 쓰이는 이미지의 양이 방대하지 않은데 각각의 폴더로 별도로 저장하는 로직이 불필요하다는 생각이 들어 기존의 post title에 따라 각각 별도의 폴더에 이미지를 저장하던 방식에서 하나의 images 폴더에 해당 페이지의 전체 포스트 이미지들을 저장하는 방식으로 수정하기로 하였습니다.\"}],\"\\n\",[\"$\",\"h2\",null,{\"className\":\"mt-20 text-3xl text-blue-900\",\"children\":\"Trouble 해결\"}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"수정 전 코드\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"const { data: imageFileList, error } = await supabase.storage\\n    .from(\\\"posts\\\")\\n    .list(`${page}/images/${postTitle}`);\\n\\nconst imageFileUrls = [];\\n\\nfor (const imageFile of imageFileList) {\\n    const { data } = supabase.storage\\n      .from(\\\"posts\\\")\\n      .getPublicUrl(`${page}/images/${postTitle}/${imageFile.name}`);\\n\\t...\\n\\timageFileUrls.push(data.publicUrl);\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"images\"}],\" 폴더 내에 다시 각 포스트의 제목을 이름으로 하는 폴더가 존재하고 그 하위에 해당 포스트에만 쓰이는 이미지가 저장되어 있는 구조입니다.\\n이미지 url을 순차적으로 가져와 \",[\"$\",\"code\",null,{\"children\":\"imageFileUrls\"}],\"에 저장하였습니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"text.replace(/!\\\\[\\\\[.*?\\\\]\\\\]/g, () =\u003e {\\n    const replacement = imageUrls[imageIndex] ? `![](${imageUrls[imageIndex]})` : \\\"[not found image]\\\";\\n    imageIndex += 1;\\n    ...\\n};\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"블로그 텍스트에 이미지 텍스트가 존재하는 곳을 index 0 부터 순차적으로 저장해둔 image url로 변환하는 코드입니다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"수정 후 코드\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"const { data: imageFileList, error } = await supabase.storage\\n\\t.from(\\\"posts\\\")\\n    .list(`${page}/images`);\\n\\nconst imageFileUrls: { [key: string]: string } = {};\\n\\nfor (const imageFile of imageFileList) {\\n    const { data } = supabase.storage\\n      .from(\\\"posts\\\")\\n      .getPublicUrl(`${page}/images/${imageFile.name}`);\\n\\t...\\n\\timageFileUrls[imageFile.name] = data.publicUrl;\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"images 폴더 하위에 블로그 내의 모든 이미지 파일이 존재합니다.\\n각 이미지의 url을 \",[\"$\",\"code\",null,{\"children\":\"imageFileUrls\"}],\"  객체에 key와 value 값으로 저장합니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"text.replace(/!\\\\[\\\\[(.*?\\\\.png)(\\\\|\\\\d+)?\\\\]\\\\]/g, (match, p1) =\u003e {\\n\\tconst replacement = imageUrlsObj[p1] ? `![](${imageUrlsObj[p1]})` : \\\"[not found image]\\\";\\n\\t...\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"블로그 텍스트에 이미지 텍스트가 존재하는 곳에 이미지 파일명이 \",[\"$\",\"code\",null,{\"children\":\"imageUrlsObj\"}],\" 객체에 키로 존재하는 경우 해당하는 image url로 변환합니다.\\n만약 image url이 존재 하지 않는 경우 해당 이미지 텍스트를 \",[\"$\",\"code\",null,{\"children\":\"[not found image]\"}],\"로 대체합니다.\"]}],\"\\n\",[\"$\",\"h2\",null,{\"className\":\"mt-20 text-3xl text-blue-900\",\"children\":\"reference\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"https://supabase.com/docs/reference/javascript/storage-from-list\\n\"}]}]]}]\n"])</script></body></html>