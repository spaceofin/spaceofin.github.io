<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185955.png"/><link rel="preload" as="image" href="https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185106.png"/><link rel="stylesheet" href="/_next/static/css/a13b559d67687ed0.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-3c60486726093425.js"/><script src="/_next/static/chunks/fd9d1056-42bca7a501e26700.js" async=""></script><script src="/_next/static/chunks/23-0400f1ada3445968.js" async=""></script><script src="/_next/static/chunks/main-app-e313d8490fffe43c.js" async=""></script><script src="/_next/static/chunks/231-6a7b6dfd7bcbf59a.js" async=""></script><script src="/_next/static/chunks/app/layout-446e62b86e627af0.js" async=""></script><title>Create Next App</title><meta name="description" content="Generated by create next app"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__variable_1e4310 __variable_c3aa02 antialiased"><nav class="font-mono mx-16"><ul class="relative min-h-32 m-14 mb-10 flex flex-col md:flex-row md:space-x-12 space-y-1 justify-center md:justify-start items-center text-2xl md:text-3xl z-0 tracking-tight text-zinc-900"><li><a href="/">Home</a></li><li><a href="/learning-logs">Learning Logs</a></li><li><a href="/commit-logs">Commit logs</a></li></ul></nav><div class="flex justify-center py-10"><div class="page-background"><div class="flex flex-col prose dark:prose-invert w-full h-full max-h-none overflow-visible px-4"><h1 class="my-20 text-4xl">Form update 하기(with RHF)</h1>
<h2 class="mt-20 text-3xl text-blue-900">Q. Form을 수정하려면 어떻게 해야 할까요?</h2>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">저장된 값 띄우기</h3>
<p>todo card의 <code>edit</code> 버튼을 클릭하면 저장된 값들이 form에 떠야합니다.</p>
<h4 class="text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500">시도 1. setValue 이용하기</h4>
<p><code>getTodoById</code> 함수를 이용하여 DB로부터 해당 todo 에 대한 정보를 가져오고 <code>setValue</code>를 이용하여 값을 하나하나 입력해주는 방식입니다.</p>
<pre><code>  useEffect(() =&gt; {
    const fetchTodoById = async () =&gt; {
      if (todoIdToUpdate) {
        todoToUpdate = await getTodoById(todoIdToUpdate);
        const {
          task,
          category,
          priority,
          startTimeStamp,
          endTimeStamp,
          memo,
          status,
        } = todoToUpdate;
        const [startDate, startTime] = startTimeStamp.slice(0, -4).split(&quot;T&quot;);
        const [endDate, endTime] = endTimeStamp.slice(0, -4).split(&quot;T&quot;);

        const dateOnly =
          startTime === &quot;00:00&quot; &amp;&amp; endTime === &quot;00:00&quot; ? true : false;

        setValue(&quot;task&quot;, task);
        setValue(&quot;category&quot;, category);
        setValue(&quot;priority&quot;, priority);
        setValue(&quot;dates.startDate&quot;, startDate);
        setValue(&quot;dates.startTime&quot;, startTime);
        setValue(&quot;dates.endDate&quot;, endDate);
        setValue(&quot;dates.endTime&quot;, endTime);
        setValue(&quot;memo&quot;, memo);
        setValue(&quot;dates.dateOnly&quot;, dateOnly);
      }
    };
    fetchTodoById();
  }, []);

</code></pre>
<h4 class="text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500">시도 2. reset 이용하기</h4>
<p><code>RHF</code>의 <code>reset</code>을 이용하여 한꺼번에 값을 주는 방법입니다.</p>
<pre><code>  useEffect(() =&gt; {
    const fetchTodoById = async () =&gt; {
      if (todoIdToUpdate) {
        todoToUpdate = await getTodoById(todoIdToUpdate);
        const { startTimeStamp, endTimeStamp } = todoToUpdate;
        const [startDate, startTime] = startTimeStamp.slice(0, -4).split(&quot;T&quot;);
        const [endDate, endTime] = endTimeStamp.slice(0, -4).split(&quot;T&quot;);
        const dateOnly =
          startTime === &quot;00:00&quot; &amp;&amp; endTime === &quot;00:00&quot; ? true : false;

        reset({
          ...todoToUpdate,
          dates: {
            startDate: startDate,
            startTime: startTime,
            endDate: endDate,
            endTime: endTime,
            dateOnly: dateOnly,
          },
        });
      }
    };
    fetchTodoById();
  }, []);
</code></pre>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">updateTodo 함수 만들기</h3>
<p>수정한 값들을 db에 업데이트할 때 사용할 <code>updateTodo</code> 함수를 만들었습니다.</p>
<pre><code>export const updateTodo = async (id: string, updatedFields: Partial&lt;Todo&gt;) =&gt; {
  const response = await fetch(`http://localhost:3001/todos/${id}`, {
    method: &quot;PATCH&quot;,
    headers: {
      &quot;Content-Type&quot;: &quot;application/json&quot;,
    },
    body: JSON.stringify(updatedFields),
  });

  if (!response.ok) {
    throw new Error(&quot;Failed to update todo&quot;);
  }

  const result = await response.json();
  return result;
};
</code></pre>
<p>전체 항목 업데이트가 아닌 바뀐 값 만을 업데이트하기 위해 <code>PATCH</code> 메소드를 사용하였고 <code>Partial&lt;Todo&gt;</code> 자료형을 갖는 updatedFields 변수를 사용하였습니다.</p>
<h4 class="text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500"><code>Partial&lt;Type&gt;</code></h4>
<p><code>Partial&lt;Type&gt;</code>은 Type의 모든 속성이 option으로 설정된 타입입니다. 이 유틸리티 타입은 주어진 Type의 모든 부분 집합을 나타내는 타입을 반환합니다.</p>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">watch를 이용한 저장된 값과 수정된 값의 비교</h3>
<h4 class="text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500">저장된 값과 수정된 값 각각 변수에 할당하기</h4>
<p>updateTodo 함수에 수정된 fields만을 전달하기 위해 수정된 값을 먼저 추출합니다.
값 변화 비교를 위해 <code>useForm</code>의 <code>watch</code> 메서드를 사용합니다.</p>
<pre><code>export default function AddInputTodo({
  todoIdToUpdate,
}: {
  todoIdToUpdate?: string;
}) {
	...
	const savedValuesRef = useRef&lt;InputTodo | null&gt;(null);
	useEffect(() =&gt; {
	  const fetchTodoById = async () =&gt; {
	    if (todoIdToUpdate) {
	      ...
	      savedValuesRef.current = watch();
	    }
	  };
	  fetchTodoById();
	}, []);

    const onSubmit: SubmitHandler&lt;InputTodo&gt; = async (todo: InputTodo) =&gt; {
      try {
        if (todoIdToUpdate) {
          const currentValues = watch();
          const savedValues = savedValuesRef.current;

		  ...(currentValues와 savedValues를 비교하는 로직)...
		} 
	  }
	}
	return ( ... );
}
</code></pre>
<p>렌더링과 훅 실행 순서에 관계 없이 같은 값을 사용하기 위해 <code>useRef</code>를 사용하여 savedValuesRef를 정의합니다.</p>
<h5 class="text-xl dark:text-xl my-2 text-slate-800 dark:text-sky-500">+) 잘못된 코드: useEffect 훅은 컴포넌트 렌더링 이후에 실행됩니다.</h5>
<pre><code>// error code
export default function AddInputTodo({
  todoIdToUpdate,
}: {
  todoIdToUpdate?: string;
}) {
	...
	let savedValues;
	useEffect(() =&gt; {
	  const fetchTodoById = async () =&gt; {
	    if (todoIdToUpdate) {
	      ...
	      savedValues = watch();
	    }
	  };
	  fetchTodoById();
	}, []);

    const onSubmit: SubmitHandler&lt;InputTodo&gt; = async (todo: InputTodo) =&gt; {
      try {
        if (todoIdToUpdate) {
          const currentValues = watch();
		  ...(currentValues와 savedValues를 비교하는 로직)...
		} 
	  }
	}
	return ( ... );
}
</code></pre>
<p>savedValues를 useEffect와 onSubmit의 외부 스코프에 선언하여 하나의 변수로 이용하려 했지만 위와 같은 코드를 작성했더니 useEffect 훅의 실행 순서 문제로 onSubmit에 전달된 savedValues는 <code>undefined</code> 값이 되었으며 watch()로 할당한 savedValues의 값은 useEffect 내부에서만 유효했습니다.</p>
<h4 class="text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500">저장된 값과 수정된 값의 비교</h4>
<pre><code>// useEffect 내부의 watch 메서드 할당 부분 코드 수정
// 수정 전: savedValuesRef.current = watch();

savedValuesRef.current = JSON.parse(JSON.stringify(watch()));
</code></pre>
<pre><code>// savedValues와 currentValues를 비교하여 값이 변한 부분만 updatedFields에 저장합니다.
const currentValues = watch();
const savedValues = savedValuesRef.current;
const updatedFields: { [key: string]: any } = {};

for (const key in savedValues) {
  const k = key as keyof InputTodo;
  if (k === &quot;dates&quot;) {
	const savedDates = savedValues.dates;
	const currentDates = currentValues.dates;
	console.log(&quot;savedDates:&quot;, savedDates);
	console.log(&quot;currentDates:&quot;, currentDates);
	for (const dateKey in savedDates) {
	  const dk = dateKey as keyof typeof savedDates;
	  if (savedDates[dk] !== currentDates[dk]) {
		if (!updatedFields.dates) {
		  updatedFields.dates = {};
		}
		updatedFields.dates[dk] = currentDates[dk];
	  }
	}
  } else if (savedValues[k] !== currentValues[k]) {
	updatedFields[k] = currentValues[k];
  }
}
</code></pre>
<p><img class="mt-1 mb-8" src="https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185955.png" alt=""/></p>
<h5 class="text-xl dark:text-xl my-2 text-slate-800 dark:text-sky-500">+) 잘못된 코드: useForm의 watch 메서드는 얕은 복사를 수행합니다.</h5>
<pre><code>//useEffect 내부의 watch 메서드를 수정하지 않았을 때
savedValuesRef.current = watch();
</code></pre>
<p>코드를 실행하고 startTime 항목을 09:00 에서 09:10 값으로 수정하고 submit 버튼을 클릭하면 아래와 같은 콘솔 로그가 찍힙니다.</p>
<p><img class="mt-1 mb-8" src="https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185106.png" alt=""/></p>
<p><code>Form</code> 창에서 Dates와 관련된 값 변경 시 currentDates 뿐 아니라 savedDates 객체의 값도 같은 값으로 동기화가 되어 버리는 문제입니다. 이 문제는 watch 메서드가 <code>얕은 복사(swallow copy)</code>를 수행하기 때문에 일어나는 결과로, savedDates와 currentDates는 같은 참조를 공유합니다. 그래서 두 객체의 값 변화가 없기 때문에 updateFields는 항상 빈 object가 되어 todo card의 업데이트가 일어나지 않게 됩니다.</p>
<h3 class="text-2xl dark:text-2xl text-sky-700 dark:text-sky-300">+) 추가(241108) - defaultValues를 사용한 기본값 사용으로 저장된 값 띄우기</h3>
<p>기존 <code>AddInputTodo</code> 컴포넌트 내에서 <code>todoIdToUpdate</code> 파라미터의 전달 유무에 따라 new todo/update todo 판단을 하던 로직을 해당 판단을 상위 컴포넌트에서 하고 조건에 따라 다른 컴포넌트를 렌더링 하도록 코드를 수정하였습니다.</p>
<p>new todo인 경우 파라미터 없이 <code>AddInputTodo</code> 컴포넌트를, update todo인 경우 매개변수를 전달하며  <code>EditInputTodo</code> 컴포넌트를 렌더링합니다.
<code>EditInputTodo</code> 컴포넌트에서는 <code>getTodoById</code> 함수로 id에 따른 todo data를 fetch 하고 해당 data를 파라미터로 전달하며 <code>AddInputTodo</code> 컴포넌트를 렌더링합니다.</p>
<p>todo에 저장된 data를 전달 받아 컴포넌트를 렌더링 하므로 <code>setValue</code>나 <code>reset</code>을 사용하지 않고 <code>userForm</code>의 <code>defaultValues</code> 옵션에 data를 바로 할당할 수 있습니다.</p>
<pre><code>// 수정 전 코드
export default function AddInputTodo({
  todoIdToUpdate,
}: {
  todoIdToUpdate?: string;
}) {
	...
	const {
	    register,
	    handleSubmit,
	    watch,
	    reset,
	    formState: { errors },
    } = useForm&lt;InputTodo&gt;({ resolver: zodResolver(inputTodoSchema) });
	...
}
</code></pre>
<pre><code>// 수정 후 코드
export default function AddInputTodo({
  todoToUpdate,
}: {
  todoToUpdate?: InputTodo;
}) {
	...
	const {
		register,
		handleSubmit,
		watch,
		formState: { errors },
	} = useForm&lt;InputTodo&gt;({
		resolver: zodResolver(inputTodoSchema),
		defaultValues: todoToUpdate
	})
	...
}
</code></pre>
<h2 class="mt-20 text-3xl text-blue-900">reference</h2>
<pre><code>https://www.typescriptlang.org/docs/handbook/utility-types.html#partialtype
</code></pre></div></div></div><script src="/_next/static/chunks/webpack-3c60486726093425.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/a13b559d67687ed0.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"2:I[5751,[],\"\"]\n5:I[9275,[],\"\"]\n7:I[1343,[],\"\"]\n8:I[5767,[\"231\",\"static/chunks/231-6a7b6dfd7bcbf59a.js\",\"185\",\"static/chunks/app/layout-446e62b86e627af0.js\"],\"PostProvider\",1]\n9:I[231,[\"231\",\"static/chunks/231-6a7b6dfd7bcbf59a.js\",\"185\",\"static/chunks/app/layout-446e62b86e627af0.js\"],\"\"]\nb:I[6130,[],\"\"]\n6:[\"slug\",\"241102-241103_commit\",\"d\"]\nc:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L2\",null,{\"buildId\":\"QPOD-7M2dUX1Dov1x8aip\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"commit-logs\",\"241102-241103_commit\"],\"initialTree\":[\"\",{\"children\":[\"commit-logs\",{\"children\":[[\"slug\",\"241102-241103_commit\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"241102-241103_commit\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"commit-logs\",{\"children\":[[\"slug\",\"241102-241103_commit\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L3\",\"$L4\",null],null],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"commit-logs\",\"children\",\"$6\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"commit-logs\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/a13b559d67687ed0.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"$L8\",null,{\"children\":[\"$\",\"body\",null,{\"className\":\"__variable_1e4310 __variable_c3aa02 antialiased\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"font-mono mx-16\",\"children\":[\"$\",\"ul\",null,{\"className\":\"relative min-h-32 m-14 mb-10 flex flex-col md:flex-row md:space-x-12 space-y-1 justify-center md:justify-start items-center text-2xl md:text-3xl z-0 tracking-tight text-zinc-900\",\"children\":[[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/\",\"children\":\"Home\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/learning-logs\",\"children\":\"Learning Logs\"}]}],[\"$\",\"li\",null,{\"children\":[\"$\",\"$L9\",null,{\"href\":\"/commit-logs\",\"children\":\"Commit logs\"}]}]]}]}],[\"$\",\"div\",null,{\"className\":\"flex justify-center py-10\",\"children\":[\"$\",\"div\",null,{\"className\":\"page-background\",\"children\":[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]}]]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Create Next App\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Generated by create next app\"}]]\n3:null\n"])</script><script>self.__next_f.push([1,"4:[\"$\",\"div\",null,{\"className\":\"flex flex-col prose dark:prose-invert w-full h-full max-h-none overflow-visible px-4\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"my-20 text-4xl\",\"children\":\"Form update 하기(with RHF)\"}],\"\\n\",[\"$\",\"h2\",null,{\"className\":\"mt-20 text-3xl text-blue-900\",\"children\":\"Q. Form을 수정하려면 어떻게 해야 할까요?\"}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"저장된 값 띄우기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"todo card의 \",[\"$\",\"code\",null,{\"children\":\"edit\"}],\" 버튼을 클릭하면 저장된 값들이 form에 떠야합니다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"className\":\"text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"시도 1. setValue 이용하기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"getTodoById\"}],\" 함수를 이용하여 DB로부터 해당 todo 에 대한 정보를 가져오고 \",[\"$\",\"code\",null,{\"children\":\"setValue\"}],\"를 이용하여 값을 하나하나 입력해주는 방식입니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"  useEffect(() =\u003e {\\n    const fetchTodoById = async () =\u003e {\\n      if (todoIdToUpdate) {\\n        todoToUpdate = await getTodoById(todoIdToUpdate);\\n        const {\\n          task,\\n          category,\\n          priority,\\n          startTimeStamp,\\n          endTimeStamp,\\n          memo,\\n          status,\\n        } = todoToUpdate;\\n        const [startDate, startTime] = startTimeStamp.slice(0, -4).split(\\\"T\\\");\\n        const [endDate, endTime] = endTimeStamp.slice(0, -4).split(\\\"T\\\");\\n\\n        const dateOnly =\\n          startTime === \\\"00:00\\\" \u0026\u0026 endTime === \\\"00:00\\\" ? true : false;\\n\\n        setValue(\\\"task\\\", task);\\n        setValue(\\\"category\\\", category);\\n        setValue(\\\"priority\\\", priority);\\n        setValue(\\\"dates.startDate\\\", startDate);\\n        setValue(\\\"dates.startTime\\\", startTime);\\n        setValue(\\\"dates.endDate\\\", endDate);\\n        setValue(\\\"dates.endTime\\\", endTime);\\n        setValue(\\\"memo\\\", memo);\\n        setValue(\\\"dates.dateOnly\\\", dateOnly);\\n      }\\n    };\\n    fetchTodoById();\\n  }, []);\\n\\n\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"className\":\"text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"시도 2. reset 이용하기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"RHF\"}],\"의 \",[\"$\",\"code\",null,{\"children\":\"reset\"}],\"을 이용하여 한꺼번에 값을 주는 방법입니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"  useEffect(() =\u003e {\\n    const fetchTodoById = async () =\u003e {\\n      if (todoIdToUpdate) {\\n        todoToUpdate = await getTodoById(todoIdToUpdate);\\n        const { startTimeStamp, endTimeStamp } = todoToUpdate;\\n        const [startDate, startTime] = startTimeStamp.slice(0, -4).split(\\\"T\\\");\\n        const [endDate, endTime] = endTimeStamp.slice(0, -4).split(\\\"T\\\");\\n        const dateOnly =\\n          startTime === \\\"00:00\\\" \u0026\u0026 endTime === \\\"00:00\\\" ? true : false;\\n\\n        reset({\\n          ...todoToUpdate,\\n          dates: {\\n            startDate: startDate,\\n            startTime: startTime,\\n            endDate: endDate,\\n            endTime: endTime,\\n            dateOnly: dateOnly,\\n          },\\n        });\\n      }\\n    };\\n    fetchTodoById();\\n  }, []);\\n\"}]}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"updateTodo 함수 만들기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"수정한 값들을 db에 업데이트할 때 사용할 \",[\"$\",\"code\",null,{\"children\":\"updateTodo\"}],\" 함수를 만들었습니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"export const updateTodo = async (id: string, updatedFields: Partial\u003cTodo\u003e) =\u003e {\\n  const response = await fetch(`http://localhost:3001/todos/${id}`, {\\n    method: \\\"PATCH\\\",\\n    headers: {\\n      \\\"Content-Type\\\": \\\"application/json\\\",\\n    },\\n    body: JSON.stringify(updatedFields),\\n  });\\n\\n  if (!response.ok) {\\n    throw new Error(\\\"Failed to update todo\\\");\\n  }\\n\\n  const result = await response.json();\\n  return result;\\n};\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"전체 항목 업데이트가 아닌 바뀐 값 만을 업데이트하기 위해 \",[\"$\",\"code\",null,{\"children\":\"PATCH\"}],\" 메소드를 사용하였고 \",[\"$\",\"code\",null,{\"children\":\"Partial\u003cTodo\u003e\"}],\" 자료형을 갖는 updatedFields 변수를 사용하였습니다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"className\":\"text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":[\"$\",\"code\",null,{\"children\":\"Partial\u003cType\u003e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"Partial\u003cType\u003e\"}],\"은 Type의 모든 속성이 option으로 설정된 타입입니다. 이 유틸리티 타입은 주어진 Type의 모든 부분 집합을 나타내는 타입을 반환합니다.\"]}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"watch를 이용한 저장된 값과 수정된 값의 비교\"}],\"\\n\",[\"$\",\"h4\",null,{\"className\":\"text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"저장된 값과 수정된 값 각각 변수에 할당하기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"updateTodo 함수에 수정된 fields만을 전달하기 위해 수정된 값을 먼저 추출합니다.\\n값 변화 비교를 위해 \",[\"$\",\"code\",null,{\"children\":\"useForm\"}],\"의 \",[\"$\",\"code\",null,{\"children\":\"watch\"}],\" 메서드를 사용합니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"export default function AddInputTodo({\\n  todoIdToUpdate,\\n}: {\\n  todoIdToUpdate?: string;\\n}) {\\n\\t...\\n\\tconst savedValuesRef = useRef\u003cInputTodo | null\u003e(null);\\n\\tuseEffect(() =\u003e {\\n\\t  const fetchTodoById = async () =\u003e {\\n\\t    if (todoIdToUpdate) {\\n\\t      ...\\n\\t      savedValuesRef.current = watch();\\n\\t    }\\n\\t  };\\n\\t  fetchTodoById();\\n\\t}, []);\\n\\n    const onSubmit: SubmitHandler\u003cInputTodo\u003e = async (todo: InputTodo) =\u003e {\\n      try {\\n        if (todoIdToUpdate) {\\n          const currentValues = watch();\\n          const savedValues = savedValuesRef.current;\\n\\n\\t\\t  ...(currentValues와 savedValues를 비교하는 로직)...\\n\\t\\t} \\n\\t  }\\n\\t}\\n\\treturn ( ... );\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"렌더링과 훅 실행 순서에 관계 없이 같은 값을 사용하기 위해 \",[\"$\",\"code\",null,{\"children\":\"useRef\"}],\"를 사용하여 savedValuesRef를 정의합니다.\"]}],\"\\n\",[\"$\",\"h5\",null,{\"className\":\"text-xl dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"+) 잘못된 코드: useEffect 훅은 컴포넌트 렌더링 이후에 실행됩니다.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"// error code\\nexport default function AddInputTodo({\\n  todoIdToUpdate,\\n}: {\\n  todoIdToUpdate?: string;\\n}) {\\n\\t...\\n\\tlet savedValues;\\n\\tuseEffect(() =\u003e {\\n\\t  const fetchTodoById = async () =\u003e {\\n\\t    if (todoIdToUpdate) {\\n\\t      ...\\n\\t      savedValues = watch();\\n\\t    }\\n\\t  };\\n\\t  fetchTodoById();\\n\\t}, []);\\n\\n    const onSubmit: SubmitHandler\u003cInputTodo\u003e = async (todo: InputTodo) =\u003e {\\n      try {\\n        if (todoIdToUpdate) {\\n          const currentValues = watch();\\n\\t\\t  ...(currentValues와 savedValues를 비교하는 로직)...\\n\\t\\t} \\n\\t  }\\n\\t}\\n\\treturn ( ... );\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"savedValues를 useEffect와 onSubmit의 외부 스코프에 선언하여 하나의 변수로 이용하려 했지만 위와 같은 코드를 작성했더니 useEffect 훅의 실행 순서 문제로 onSubmit에 전달된 savedValues는 \",[\"$\",\"code\",null,{\"children\":\"undefined\"}],\" 값이 되었으며 watch()로 할당한 savedValues의 값은 useEffect 내부에서만 유효했습니다.\"]}],\"\\n\",[\"$\",\"h4\",null,{\"className\":\"text-xl font-bold dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"저장된 값과 수정된 값의 비교\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"// useEffect 내부의 watch 메서드 할당 부분 코드 수정\\n// 수정 전: savedValuesRef.current = watch();\\n\\nsavedValuesRef.current = JSON.parse(JSON.stringify(watch()));\\n\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"// savedValues와 currentValues를 비교하여 값이 변한 부분만 updatedFields에 저장합니다.\\nconst currentValues = watch();\\nconst savedValues = savedValuesRef.current;\\nconst updatedFields: { [key: string]: any } = {};\\n\\nfor (const key in savedValues) {\\n  const k = key as keyof InputTodo;\\n  if (k === \\\"dates\\\") {\\n\\tconst savedDates = savedValues.dates;\\n\\tconst currentDates = currentValues.dates;\\n\\tconsole.log(\\\"savedDates:\\\", savedDates);\\n\\tconsole.log(\\\"currentDates:\\\", currentDates);\\n\\tfor (const dateKey in savedDates) {\\n\\t  const dk = dateKey as keyof typeof savedDates;\\n\\t  if (savedDates[dk] !== currentDates[dk]) {\\n\\t\\tif (!updatedFields.dates) {\\n\\t\\t  updatedFields.dates = {};\\n\\t\\t}\\n\\t\\tupdatedFields.dates[dk] = currentDates[dk];\\n\\t  }\\n\\t}\\n  } else if (savedValues[k] !== currentValues[k]) {\\n\\tupdatedFields[k] = currentValues[k];\\n  }\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"className\":\"mt-1 mb-8\",\"src\":\"https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185955.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"h5\",null,{\"className\":\"text-xl dark:text-xl my-2 text-slate-800 dark:text-sky-500\",\"children\":\"+) 잘못된 코드: useForm의 watch 메서드는 얕은 복사를 수행합니다.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"//useEffect 내부의 watch 메서드를 수정하지 않았을 때\\nsavedValuesRef.current = watch();\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"코드를 실행하고 startTime 항목을 09:00 에서 09:10 값으로 수정하고 submit 버튼을 클릭하면 아래와 같은 콘솔 로그가 찍힙니다.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"className\":\"mt-1 mb-8\",\"src\":\"https://mizcysqzabsegohkcjcx.supabase.co/storage/v1/object/public/posts/commit-logs/images/Pasted%20image%2020241104185106.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"Form\"}],\" 창에서 Dates와 관련된 값 변경 시 currentDates 뿐 아니라 savedDates 객체의 값도 같은 값으로 동기화가 되어 버리는 문제입니다. 이 문제는 watch 메서드가 \",[\"$\",\"code\",null,{\"children\":\"얕은 복사(swallow copy)\"}],\"를 수행하기 때문에 일어나는 결과로, savedDates와 currentDates는 같은 참조를 공유합니다. 그래서 두 객체의 값 변화가 없기 때문에 updateFields는 항상 빈 object가 되어 todo card의 업데이트가 일어나지 않게 됩니다.\"]}],\"\\n\",[\"$\",\"h3\",null,{\"className\":\"text-2xl dark:text-2xl text-sky-700 dark:text-sky-300\",\"children\":\"+) 추가(241108) - defaultValues를 사용한 기본값 사용으로 저장된 값 띄우기\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"기존 \",[\"$\",\"code\",null,{\"children\":\"AddInputTodo\"}],\" 컴포넌트 내에서 \",[\"$\",\"code\",null,{\"children\":\"todoIdToUpdate\"}],\" 파라미터의 전달 유무에 따라 new todo/update todo 판단을 하던 로직을 해당 판단을 상위 컴포넌트에서 하고 조건에 따라 다른 컴포넌트를 렌더링 하도록 코드를 수정하였습니다.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"new todo인 경우 파라미터 없이 \",[\"$\",\"code\",null,{\"children\":\"AddInputTodo\"}],\" 컴포넌트를, update todo인 경우 매개변수를 전달하며  \",[\"$\",\"code\",null,{\"children\":\"EditInputTodo\"}],\" 컴포넌트를 렌더링합니다.\\n\",[\"$\",\"code\",null,{\"children\":\"EditInputTodo\"}],\" 컴포넌트에서는 \",[\"$\",\"code\",null,{\"children\":\"getTodoById\"}],\" 함수로 id에 따른 todo data를 fetch 하고 해당 data를 파라미터로 전달하며 \",[\"$\",\"code\",null,{\"children\":\"AddInputTodo\"}],\" 컴포넌트를 렌더링합니다.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"todo에 저장된 data를 전달 받아 컴포넌트를 렌더링 하므로 \",[\"$\",\"code\",null,{\"children\":\"setValue\"}],\"나 \",[\"$\",\"code\",null,{\"children\":\"reset\"}],\"을 사용하지 않고 \",[\"$\",\"code\",null,{\"children\":\"userForm\"}],\"의 \",[\"$\",\"code\",null,{\"children\":\"defaultValues\"}],\" 옵션에 data를 바로 할당할 수 있습니다.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"// 수정 전 코드\\nexport default function AddInputTodo({\\n  todoIdToUpdate,\\n}: {\\n  todoIdToUpdate?: string;\\n}) {\\n\\t...\\n\\tconst {\\n\\t    register,\\n\\t    handleSubmit,\\n\\t    watch,\\n\\t    reset,\\n\\t    formState: { errors },\\n    } = useForm\u003cInputTodo\u003e({ resolver: zodResolver(inputTodoSchema) });\\n\\t...\\n}\\n\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"// 수정 후 코드\\nexport default function AddInputTodo({\\n  todoToUpdate,\\n}: {\\n  todoToUpdate?: InputTodo;\\n}) {\\n\\t...\\n\\tconst {\\n\\t\\tregister,\\n\\t\\thandleSubmit,\\n\\t\\twatch,\\n\\t\\tformState: { errors },\\n\\t} = useForm\u003cInputTodo\u003e({\\n\\t\\tresolver: zodResolver(inputTodoSchema),\\n\\t\\tdefaultValues: todoToUpdate\\n\\t})\\n\\t...\\n}\\n\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"className\":\"mt-20 text-3xl text-blue-900\",\"children\":\"reference\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"https://www.typescriptlang.org/docs/handbook/utility-types.html#partialtype\\n\"}]}]]}]\n"])</script></body></html>